local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

local ENABLED = false
local KILL_DELAY = 0.3

local isKilling = false
local lastKillTime = 0

local function isInGame(character)
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return false end
    
    local gameMap = Workspace:FindFirstChild("GameMap")
    if not gameMap then return false end
    
    for _, child in pairs(gameMap:GetDescendants()) do
        if child:IsA("BasePart") then
            local dist = (child.Position - root.Position).Magnitude
            if dist < 500 then
                return true
            end
        end
    end
    
    return false
end

local function equipKnife()
    local myChar = LocalPlayer.Character
    if not myChar then return false end
    
    if myChar:FindFirstChild("Knife") then
        return true
    end
    
    local knife = LocalPlayer.Backpack:FindFirstChild("Knife")
    if knife then
        local humanoid = myChar:FindFirstChild("Humanoid")
        if humanoid then
            humanoid:EquipTool(knife)
            task.wait(0.2)
            return true
        end
    end
    
    return false
end

local function getMousePosition()
    local mouse = LocalPlayer:GetMouse()
    return mouse.Hit.Position
end

local function getPlayerNearCursor()
    local mousePos = getMousePosition()
    local nearest = nil
    local nearestDist = math.huge
    
    for _, obj in pairs(Workspace:GetChildren()) do
        if obj:IsA("Model") and obj ~= LocalPlayer.Character and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("HumanoidRootPart") then
            local hum = obj.Humanoid
            if hum.Health > 0 and isInGame(obj) then
                local dist = (obj.HumanoidRootPart.Position - mousePos).Magnitude
                if dist < nearestDist then
                    nearestDist = dist
                    nearest = obj
                end
            end
        end
    end
    
    return nearest
end

local function findAllInGameEnemies()
    local myChar = LocalPlayer.Character
    if not myChar or not isInGame(myChar) then
        return {}
    end
    
    local enemies = {}
    
    for _, obj in pairs(Workspace:GetChildren()) do
        if obj:IsA("Model") and obj ~= myChar and obj:FindFirstChild("Humanoid") and obj:FindFirstChild("HumanoidRootPart") then
            local hum = obj.Humanoid
            if hum.Health > 0 and isInGame(obj) then
                table.insert(enemies, obj)
            end
        end
    end
    
    return enemies
end

local function clickAt(position)
    local mouse = LocalPlayer:GetMouse()
    
    if mouse1click then
        mouse1click()
    elseif mouse1press then
        mouse1press()
        task.wait(0.05)
        mouse1release()
    end
end

local function killTarget(target)
    local myChar = LocalPlayer.Character
    if not myChar or not myChar:FindFirstChild("HumanoidRootPart") then
        return
    end
    
    local myRoot = myChar.HumanoidRootPart
    local targetRoot = target:FindFirstChild("HumanoidRootPart")
    if not targetRoot then return end
    
    if not equipKnife() then
        return
    end
    
    local hitbox = myChar:FindFirstChild("baseHitbox")
    local originalHitboxSize = nil
    
    if hitbox and hitbox:IsA("BasePart") then
        originalHitboxSize = hitbox.Size
        hitbox.Size = Vector3.new(50, 50, 50)
        hitbox.Massless = true
    end
    
    local originalPos = myRoot.CFrame
    
    myRoot.CFrame = targetRoot.CFrame
    
    if hitbox then
        hitbox.CFrame = targetRoot.CFrame
    end
    
    task.wait(0.1)
    
    for i = 1, 5 do
        clickAt(targetRoot.Position)
        task.wait(0.05)
    end
    
    task.wait(0.2)
    
    if hitbox and originalHitboxSize then
        hitbox.Size = originalHitboxSize
    end
    
    myRoot.CFrame = originalPos
end

UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    
    if input.KeyCode == Enum.KeyCode.K then
        local myChar = LocalPlayer.Character
        if not myChar or not isInGame(myChar) then
            return
        end
        
        local target = getPlayerNearCursor()
        
        if target then
            killTarget(target)
        end
    end
    
    if input.KeyCode == Enum.KeyCode.H then
        ENABLED = not ENABLED
        
        if ENABLED then
            equipKnife()
        end
    end
end)

RunService.Heartbeat:Connect(function()
    if not ENABLED then return end
    if isKilling then return end
    
    local currentTime = tick()
    if currentTime - lastKillTime < KILL_DELAY then
        return
    end
    
    local myChar = LocalPlayer.Character
    if not myChar or not isInGame(myChar) then
        return
    end
    
    isKilling = true
    
    local enemies = findAllInGameEnemies()
    
    if #enemies > 0 then
        
        for _, enemy in ipairs(enemies) do
            killTarget(enemy)
            task.wait(0.1)
        end
    end
    
    lastKillTime = tick()
    isKilling = false
end)

LocalPlayer.CharacterAdded:Connect(function(character)
    task.wait(1)
    if ENABLED then
        equipKnife()
    end
end)
